<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Taylor Hoffman Research Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root {
      --bg: #050816;
      --bg-elevated: #0b1020;
      --accent: #4f46e5;
      --accent-soft: rgba(79, 70, 229, 0.12);
      --accent-border: rgba(129, 140, 248, 0.6);
      --text-main: #f9fafb;
      --text-muted: #9ca3af;
      --border-subtle: rgba(148, 163, 184, 0.25);
      --danger: #ef4444;
      --radius-lg: 16px;
      --radius-md: 10px;
      --shadow-soft: 0 18px 45px rgba(15,23,42,0.9);
      --shadow-subtle: 0 10px 30px rgba(15,23,42,0.6);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont,
        "SF Pro Text", "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #111827 0, #020617 40%, #020617 100%);
      color: var(--text-main);
      min-height: 100vh;
    }

    .page {
      max-width: 1120px;
      margin: 0 auto;
      padding: 24px 16px 48px;
    }

    /**************** HEADER ****************/
    .header {
      position: sticky;
      top: 0;
      z-index: 50;
      padding-bottom: 16px;
      margin-bottom: 24px;
      backdrop-filter: blur(20px);
      background: linear-gradient(
        to bottom,
        rgba(2,6,23,0.95),
        rgba(2,6,23,0.88),
        transparent
      );
    }

    .brand-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 14px;
    }

    .brand-title {
      font-size: 1.3rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .brand-subtitle {
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    .back-btn {
      display: none;
      border-radius: 999px;
      padding: 7px 12px;
      font-size: 0.78rem;
      border: 1px solid rgba(148,163,184,0.5);
      background: rgba(15,23,42,0.85);
      cursor: pointer;
    }

    /**************** SEARCH ****************/
    .search-upload-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
    }

    .search-container {
      position: relative;
      flex: 1;
      min-width: 260px;
    }

    .search-box {
      display: flex;
      gap: 8px;
      align-items: center;
      background: radial-gradient(circle at top left,#111827,#020617);
      padding: 10px 14px;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      box-shadow: var(--shadow-subtle);
    }

    .search-input {
      width: 100%;
      background: transparent;
      border: none;
      color: var(--text-main);
      font-size: 0.95rem;
      outline: none;
    }

    .results-dropdown {
      position: absolute;
      top: 44px;
      left: 0;
      right: 0;
      background: #020617;
      border-radius: 18px;
      border: 1px solid var(--border-subtle);
      box-shadow: var(--shadow-soft);
      max-height: 260px;
      overflow-y: auto;
      display: none;
      z-index: 40;
    }

    .results-dropdown.visible {
      display: block;
    }

    .result-item {
      padding: 10px 14px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      transition: background .15s;
    }

    .result-item:hover {
      background: rgba(79,70,229,0.16);
    }

    .btn-upload {
      background: var(--accent);
      border: none;
      padding: 8px 14px;
      border-radius: 999px;
      color: #e5e7eb;
      cursor: pointer;
      font-size: 0.82rem;
      box-shadow: 0 10px 30px rgba(79,70,229,0.7);
      white-space: nowrap;
    }

    /**************** MENU HUB ****************/
    .menu-hub {
      margin-top: 16px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px,1fr));
      gap: 14px;
    }

    .menu-card {
      padding: 18px 16px;
      min-height: 90px;
      border-radius: var(--radius-lg);
      background: radial-gradient(circle at top left,#0b1020,#020617);
      border: 1px solid rgba(148,163,184,0.35);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: .12s ease;
      box-shadow: var(--shadow-subtle);
    }

    .menu-card:hover {
      transform: translateY(-2px);
      border-color: var(--accent-border);
      box-shadow: 0 16px 40px rgba(15,23,42,0.9);
    }

    .menu-card-label {
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: .08em;
    }

    /**************** SNAPSHOT ABOVE HOLDINGS ****************/
    #snapshotSection {
      display: none;
      margin-top: 14px;
    }

    .snapshot-card {
      padding: 20px 18px;
      border-radius: var(--radius-lg);
      background: radial-gradient(circle at top left,#020617,#020617);
      border: 1px solid rgba(148,163,184,0.7);
      margin-bottom: 24px;
      box-shadow: var(--shadow-soft);
    }

    .snapshot-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .ticker-chip {
      padding: 3px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.7);
      font-size: 0.75rem;
      background: rgba(15,23,42,0.8);
    }

    /**************** HOLDINGS ****************/
    .holdings-section {
      margin-top: 16px;
      margin-bottom: 24px;
    }

    .holdings-grid {
      margin-top: 10px;
      display: grid;
      grid-template-columns: repeat(auto-fit,minmax(180px,1fr));
      gap: 12px;
    }

    .holding-card {
      border-radius: 14px;
      padding: 10px;
      background: radial-gradient(circle at top left,#020617,#020617);
      border: 1px solid rgba(30,64,175,0.7);
      cursor: pointer;
      transition: .12s;
    }

    .holding-card:hover {
      transform: translateY(-2px);
      border-color: rgba(129,140,248,0.9);
      box-shadow: 0 12px 30px rgba(15,23,42,0.9);
    }

    .holding-name {
      font-size: 0.86rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /**************** MENU VIEW (Portfolio + Stock Universe) ****************/
    .menu-view {
      display: none;
      margin-top: 20px;
    }

    .menu-view-inner {
      padding: 16px 14px;
      border-radius: var(--radius-lg);
      background: radial-gradient(circle at top left,#020617,#020617);
      border: 1px solid rgba(148,163,184,0.35);
      box-shadow: var(--shadow-soft);
    }

    /**************** TABLES ****************/
    .table-container {
      width: 100%;
      overflow-x: auto;
      border-radius: 14px;
      border: 1px solid rgba(55,65,81,0.9);
      margin-top: 12px;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
    }

    .data-table th {
      cursor: pointer;
      padding: 8px 6px;
      border-bottom: 1px solid rgba(31,41,55,0.9);
      background: rgba(15,23,42,0.95);
    }

    .data-table td {
      padding: 7px 6px;
      border-bottom: 1px solid rgba(31,41,55,0.9);
      text-align: center;
      white-space: nowrap;
    }

    .data-table tbody tr:nth-child(even) {
      background: rgba(15,23,42,0.55);
    }

    .data-table tbody tr:hover {
      background: rgba(30,64,175,0.3);
    }

    .sort-indicator {
      margin-left: 4px;
      font-size: 0.7rem;
      opacity: .7;
    }

    /**************** TOAST ****************/
    .toast {
      position: fixed;
      right: 20px;
      bottom: 20px;
      padding: 12px 18px;
      border-radius: 12px;
      background: var(--bg-elevated);
      border: 1px solid var(--accent-border);
      box-shadow: var(--shadow-soft);
      opacity: 0;
      transition: opacity .3s;
      z-index: 1000;
    }

    .toast.show { opacity: 1; }
  </style>
</head>

<body>
<div class="page">

  <!-- HEADER -->
  <header class="header">
    <div class="brand-row">
      <div>
        <div class="brand-title">Taylor Hoffman Inc.</div>
        <div class="brand-subtitle">Internal Equity Research Portal</div>
      </div>
      <button id="backBtn" class="back-btn">← Back</button>
    </div>

    <div class="search-upload-row">
      <div class="search-container">
        <div class="search-box">
          <input id="companySearch" class="search-input"
            type="text" placeholder="Search by company or ticker…"/>
        </div>
        <div id="resultsDropdown" class="results-dropdown"></div>
      </div>

      <button id="uploadBtn" class="btn-upload">Upload Companies CSV</button>
      <input id="fileInput" type="file" accept=".csv" style="display:none;" />
    </div>
  </header>

  <!-- MENU HUB -->
  <section id="menuHub" class="menu-hub">

    <div class="menu-card" data-view="portfolio">
      <span class="menu-card-label">Portfolio Rankings</span>
    </div>

    <div class="menu-card" data-view="stockUniverse">
      <span class="menu-card-label">Stock Universe</span>
    </div>

    <div class="menu-card" data-view="placeholder1">
      <span class="menu-card-label">Placeholder</span>
    </div>

    <div class="menu-card" data-view="placeholder2">
      <span class="menu-card-label">Placeholder</span>
    </div>

  </section>

  <!-- SNAPSHOT SECTION (NOW ABOVE HOLDINGS) -->
  <section id="snapshotSection"></section>

  <!-- HOLDINGS SECTION -->
  <section id="holdingsSection" class="holdings-section">
    <h3 style="margin-bottom:6px;letter-spacing:0.14em;text-transform:uppercase;color:#9ca3af;">
      Portfolio Holdings
    </h3>
    <div style="color:#6b7280;font-size:0.84rem;margin-bottom:8px;">
      Coverage universe tiles — click any company to open its snapshot.
    </div>
    <div id="holdingsGrid" class="holdings-grid"></div>
  </section>

  <!-- MENU VIEW (Portfolio, Stock Universe, etc.) -->
  <section id="menuView" class="menu-view"></section>

  <!-- PLACEHOLDER + SNAPSHOT (OLD POSITION) -->
  <main>
    <div id="placeholder" class="placeholder" style="
      margin-top:16px;
      border:1px dashed rgba(148,163,184,0.7);
      border-radius:var(--radius-lg);
      padding:18px 16px;
      color:var(--text-muted);
      font-size:0.86rem;">
      Upload a company list CSV or search/select a company to load its snapshot.
    </div>

    <!-- Snapshot container used by JS -->
    <div id="snapshotContainer"></div>
  </main>
    <!-- Hidden upload inputs -->
    <input type="file" id="reportFileInput" accept="application/pdf" multiple style="display:none;" />
    <input type="file" id="portfolioFileInput" accept=".csv" style="display:none;" />
    <input type="file" id="universeFileInput" accept=".csv" style="display:none;" />

    <!-- Toast -->
    <div id="toast" class="toast"></div>

    <!-- ========================= -->
    <!-- APP SCRIPT (BEGIN JS)     -->
    <!-- ========================= -->
    <script type="module">

    /*******************************************************
     * FIREBASE INITIALIZATION
     *******************************************************/
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-analytics.js";
    import {
      getFirestore,
      collection,
      getDocs,
      setDoc,
      doc,
      deleteDoc
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    import {
      getStorage,
      ref,
      uploadBytes,
      getDownloadURL
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCvkNdmrZ9Nt8osFM7TtCwe7Sw7xGPLp3Q",
      authDomain: "thcm-f24f1.firebaseapp.com",
      projectId: "thcm-f24f1",
      storageBucket: "thcm-f24f1.firebasestorage.app",
      messagingSenderId: "192941719200",
      appId: "1:192941719200:web:5ea861d487b635214093c5",
      measurementId: "G-15Q7VPVKPF"
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    /*******************************************************
     * STATE VARIABLES
     *******************************************************/
    let companies = [];
    let activeView = "menu";
    let currentReportCompanyId = null;

    /* Portfolio data */
    let portfolioData = [];
    let portfolioSort = { key:"rank", direction:"asc" };

    /* Stock Universe data */
    let universeData = [];
    let universeSort = { key:"rank", direction:"asc" };

    /*******************************************************
     * DOM ELEMENTS
     *******************************************************/
    const searchInput = document.getElementById("companySearch");
    const resultsDropdown = document.getElementById("resultsDropdown");
    const snapshotSection = document.getElementById("snapshotSection");
    const snapshotContainer = document.getElementById("snapshotContainer");
    const placeholder = document.getElementById("placeholder");
    const holdingsGrid = document.getElementById("holdingsGrid");
    const menuView = document.getElementById("menuView");
    const menuHub = document.getElementById("menuHub");
    const backBtn = document.getElementById("backBtn");
    const holdingsSection = document.getElementById("holdingsSection");

    const uploadBtn = document.getElementById("uploadBtn");
    const fileInput = document.getElementById("fileInput");
    const portfolioFileInput = document.getElementById("portfolioFileInput");
    const universeFileInput = document.getElementById("universeFileInput");

    const toast = document.getElementById("toast");

    /*******************************************************
     * TOAST HELPER
     *******************************************************/
    function showToast(msg, ok=true) {
      toast.textContent = msg;
      toast.style.borderColor = ok ? "var(--accent-border)" : "var(--danger)";
      toast.classList.add("show");
      setTimeout(() => toast.classList.remove("show"), 2600);
    }

    /*******************************************************
     * MENU NAVIGATION HANDLING
     *******************************************************/
    menuHub.addEventListener("click", (e) => {
      const card = e.target.closest(".menu-card");
      if (!card) return;
      openMenuView(card.dataset.view);
    });

    backBtn.addEventListener("click", () => showMenu());

    function openMenuView(view) {
      activeView = view;

      menuHub.style.display = "none";
      holdingsSection.style.display = "none";
      snapshotSection.style.display = "none";
      placeholder.style.display = "none";
      snapshotContainer.innerHTML = "";
      backBtn.style.display = "inline-flex";

      menuView.style.display = "block";
      menuView.innerHTML = buildMenuView(view);

      if (view === "portfolio") setupPortfolioView();
      if (view === "stockUniverse") setupUniverseView();
    }

    function showMenu() {
      activeView = "menu";

      menuHub.style.display = "grid";
      holdingsSection.style.display = "block";
      backBtn.style.display = "none";

      snapshotSection.style.display = "none";
      menuView.style.display = "none";
      placeholder.style.display = "block";

      snapshotContainer.innerHTML = "";
    }

    /*******************************************************
     * MENU VIEW BUILDER
     *******************************************************/
    function buildMenuView(view) {

      if (view === "portfolio") {
        return `
          <div class="menu-view-inner">
            <div class="portfolio-controls">
              <h2 class="menu-view-title">Portfolio Rankings</h2>
              <button id="portfolioUploadBtn" class="btn-upload">Upload Rankings CSV</button>
            </div>
            <div class="menu-view-subtitle">Full CSV template with Rank as first column.</div>
            <div id="portfolioTableContainer"></div>
          </div>
        `;
      }

      if (view === "stockUniverse") {
        return `
          <div class="menu-view-inner">
            <div class="portfolio-controls">
              <h2 class="menu-view-title">Stock Universe</h2>
              <button id="universeUploadBtn" class="btn-upload">Upload Universe CSV</button>
            </div>
            <div class="menu-view-subtitle">Matches Portfolio Rankings template exactly.</div>
            <div id="universeTableContainer"></div>
          </div>
        `;
      }

      return `
        <div class="menu-view-inner">
          <h2 class="menu-view-title">Placeholder Section</h2>
          <div class="menu-view-subtitle">Reserved for future internal tools.</div>
        </div>
      `;
    }
    /*******************************************************
     * FIRESTORE HELPERS — LOAD/SAVE COMPANIES
     *******************************************************/
    async function loadCompaniesFromFirestore() {
      const snap = await getDocs(collection(db, "companies"));
      const out = [];
      snap.forEach(docSnap => {
        const d = docSnap.data();
        out.push({
          id: docSnap.id,
          ticker: d.ticker,
          name: d.name,
          sector: d.sector,
          coverage: d.coverage
        });
      });
      return out;
    }

    async function saveCompaniesToFirestore(arr) {
      const writes = arr.map(c => {
        return setDoc(doc(db, "companies", c.ticker), {
          ticker: c.ticker,
          name: c.name,
          sector: c.sector,
          coverage: c.coverage
        });
      });
      await Promise.all(writes);
    }

    /*******************************************************
     * LOAD HOLDINGS + RENDER GRID
     *******************************************************/
    function getCoverageClass(coverage) {
      if (!coverage) return "coverage-unknown";
      const c = coverage.toLowerCase();
      if (c.includes("inactive") || c.includes("watch")) return "coverage-inactive";
      if (c.includes("active")) return "coverage-active";
      return "coverage-unknown";
    }

    function renderHoldingsGrid() {
      if (!companies.length) {
        holdingsGrid.innerHTML = `
          <div style="color:var(--text-muted);font-size:0.84rem;">
            No companies loaded yet. Upload CSV.
          </div>
        `;
        return;
      }

      const sorted = [...companies].sort((a,b)=>
        a.name.localeCompare(b.name)
      );

      holdingsGrid.innerHTML = sorted.map(c => `
        <div class="holding-card" data-id="${c.id}">
          <div class="holding-name">${c.name}</div>
          <div style="color:#9ca3af;font-size:0.78rem;margin-bottom:4px;">
            ${c.ticker}
          </div>
          <div class="holding-coverage ${getCoverageClass(c.coverage)}"
               style="display:inline-flex;align-items:center;gap:6px;font-size:0.75rem;
               border:1px solid rgba(148,163,184,0.5);padding:2px 8px;border-radius:999px;">
            <span class="coverage-dot"
              style="width:6px;height:6px;border-radius:50%;"></span>
            <span>${c.coverage}</span>
          </div>
        </div>
      `).join("");
    }

    holdingsGrid.addEventListener("click",(e)=>{
      const card = e.target.closest(".holding-card");
      if (!card) return;
      const id = card.dataset.id;
      const c = companies.find(x=>x.id===id);
      if (!c) return;
      showMenu();  // collapse menu
      searchInput.value = `${c.name} (${c.ticker})`;
      renderCompanySnapshot(c);
    });

    /*******************************************************
     * COMPANY CSV UPLOAD (COVERAGE)
     *******************************************************/
    uploadBtn.addEventListener("click",()=> fileInput.click());
    fileInput.addEventListener("change", handleCompanyUpload);

    function parseCompanyCSV(text) {
      const lines = text.trim().split(/\r?\n/);
      if (lines.length < 2) throw new Error("CSV must include header + rows.");

      const headers = lines[0].split(",").map(h => h.trim().toLowerCase());

      const idxTicker = headers.indexOf("ticker");
      const idxName = headers.indexOf("name");
      const idxSector = headers.indexOf("sector");
      const idxCoverage = headers.indexOf("coverage");

      if (idxTicker === -1 || idxName === -1)
        throw new Error("CSV missing required columns: Ticker, Name");

      const out = [];
      for (let i=1;i<lines.length;i++) {
        const row = lines[i].trim();
        if (!row) continue;
        const cols = row.split(",");
        out.push({
          id: cols[idxTicker].trim(),
          ticker: cols[idxTicker].trim(),
          name: cols[idxName].trim(),
          sector: idxSector!==-1 ? cols[idxSector].trim() : "—",
          coverage: idxCoverage!==-1 ? cols[idxCoverage].trim() : "Unspecified"
        });
      }
      return out;
    }

    async function handleCompanyUpload(evt) {
      const file = evt.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = async e => {
        try {
          const parsed = parseCompanyCSV(e.target.result);
          await saveCompaniesToFirestore(parsed);
          companies = await loadCompaniesFromFirestore();
          renderHoldingsGrid();
          showToast("Companies uploaded.");
        } catch(err) {
          showToast(err.message,false);
        } finally {
          fileInput.value = "";
        }
      };
      reader.readAsText(file);
    }

    /*******************************************************
     * PORTFOLIO CSV PARSER (Rank as first column)
     *******************************************************/
    function parsePortfolioCSV(text) {
      const lines = text.trim().split(/\r?\n/);
      if (lines.length < 2) throw new Error("Invalid CSV — no data.");

      const headers = lines[0].split(",").map(h => h.trim().toLowerCase());

      const required = [
        "rank","ticker","company","total score","quality score",
        "value score","growth score","roic","fcf yield","p/e",
        "forward p/e","current price","relative valuation price",
        "premium/discount %"
      ];

      const idx = {};
      required.forEach(col => {
        const i = headers.indexOf(col);
        if (i===-1) throw new Error(`Missing column: ${col}`);
        idx[col] = i;
      });

      const out = [];
      for (let i=1;i<lines.length;i++) {
        const row = lines[i].trim();
        if (!row) continue;
        const c = row.split(",");
        const get = name => c[idx[name]] ? c[idx[name]].trim() : "";

        out.push({
          rank: get("rank"),
          ticker: get("ticker"),
          company: get("company"),
          totalScore: get("total score"),
          qualityScore: get("quality score"),
          valueScore: get("value score"),
          growthScore: get("growth score"),
          roic: get("roic"),
          fcfYield: get("fcf yield"),
          pe: get("p/e"),
          forwardPe: get("forward p/e"),
          currentPrice: get("current price"),
          relativeValuationPrice: get("relative valuation price"),
          premiumDiscountPct: get("premium/discount %")
        });
      }
      return out;
    }

    /*******************************************************
     * PORTFOLIO — Firestore Replace Entire Collection
     *******************************************************/
    async function replacePortfolioInFirestore(rows) {
      const colRef = collection(db,"portfolioRankings");
      const snap = await getDocs(colRef);

      // Delete all existing docs
      const deletes = snap.docs.map(d => deleteDoc(d.ref));
      await Promise.all(deletes);

      // Write each row
      const writes = rows.map(r => {
        const id = r.ticker || Math.random().toString(36).slice(2);
        return setDoc(doc(db,"portfolioRankings",id), r);
      });
      await Promise.all(writes);
    }

    async function loadPortfolioFromFirestore() {
      const snap = await getDocs(collection(db,"portfolioRankings"));
      const out = [];
      snap.forEach(docSnap => out.push(docSnap.data()));
      return out;
    }

    /*******************************************************
     * STOCK UNIVERSE — Same structure as Portfolio
     *******************************************************/
    function parseUniverseCSV(text) {
      return parsePortfolioCSV(text); // identical template
    }

    async function replaceUniverseInFirestore(rows) {
      const colRef = collection(db,"stockUniverse");
      const snap = await getDocs(colRef);

      const deletes = snap.docs.map(d => deleteDoc(d.ref));
      await Promise.all(deletes);

      const writes = rows.map(r=>{
        const id = r.ticker || Math.random().toString(36).slice(2);
        return setDoc(doc(db,"stockUniverse",id), r);
      });
      await Promise.all(writes);
    }

    async function loadUniverseFromFirestore() {
      const snap = await getDocs(collection(db,"stockUniverse"));
      const out = [];
      snap.forEach(docSnap => out.push(docSnap.data()));
      return out;
    }

    /*******************************************************
     * SHARED SORTING LOGIC
     *******************************************************/
    function sortTable(data, sort) {
      const { key, direction } = sort;
      const dir = direction === "asc" ? 1 : -1;

      data.sort((a,b)=>{
        const va = a[key];
        const vb = b[key];

        // Numeric sort if numbers
        const na = parseFloat(va);
        const nb = parseFloat(vb);
        if (!isNaN(na) && !isNaN(nb)) return (na-nb)*dir;

        // Otherwise string sort
        return String(va).localeCompare(String(vb)) * dir;
      });
    }

    /*******************************************************
     * RENDER PORTFOLIO TABLE
     *******************************************************/
    function renderPortfolioTable() {
      const container = document.getElementById("portfolioTableContainer");
      if (!portfolioData.length) {
        container.innerHTML = `
          <div style="padding:10px;color:var(--text-muted);">
            No data loaded. Upload a Portfolio CSV.
          </div>
        `;
        return;
      }

      sortTable(portfolioData, portfolioSort);

      const h = (label, key) => {
        const arrow = portfolioSort.key===key
          ? (portfolioSort.direction==="asc" ? "▲" : "▼")
          : "";
        return `<th data-key="${key}">
          ${label}<span class="sort-indicator">${arrow}</span>
        </th>`;
      };

      container.innerHTML = `
        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                ${h("Rank","rank")}
                ${h("Ticker","ticker")}
                ${h("Company","company")}
                ${h("Total","totalScore")}
                ${h("Quality","qualityScore")}
                ${h("Value","valueScore")}
                ${h("Growth","growthScore")}
                ${h("ROIC","roic")}
                ${h("FCF Yield","fcfYield")}
                ${h("P/E","pe")}
                ${h("Fwd P/E","forwardPe")}
                ${h("Price","currentPrice")}
                ${h("RV Price","relativeValuationPrice")}
                ${h("Prem/Disc %","premiumDiscountPct")}
              </tr>
            </thead>
            <tbody>
              ${portfolioData.map(r=>`
                <tr>
                  <td>${r.rank}</td>
                  <td>${r.ticker}</td>
                  <td>${r.company}</td>
                  <td>${r.totalScore}</td>
                  <td>${r.qualityScore}</td>
                  <td>${r.valueScore}</td>
                  <td>${r.growthScore}</td>
                  <td>${r.roic}</td>
                  <td>${r.fcfYield}</td>
                  <td>${r.pe}</td>
                  <td>${r.forwardPe}</td>
                  <td>${r.currentPrice}</td>
                  <td>${r.relativeValuationPrice}</td>
                  <td>${r.premiumDiscountPct}</td>
                </tr>
              `).join("")}
            </tbody>
          </table>
        </div>
      `;

      attachPortfolioSortHandlers();
    }

    function attachPortfolioSortHandlers() {
      const headers = document.querySelectorAll(
        "#portfolioTableContainer th[data-key]"
      );
      headers.forEach(th => {
        th.onclick = () => {
          const key = th.dataset.key;
          if (portfolioSort.key === key) {
            portfolioSort.direction = portfolioSort.direction==="asc"?"desc":"asc";
          } else {
            portfolioSort.key = key;
            portfolioSort.direction = "asc";
          }
          renderPortfolioTable();
        };
      });
    }

    /*******************************************************
     * RENDER STOCK UNIVERSE TABLE
     *******************************************************/
    function renderUniverseTable() {
      const container = document.getElementById("universeTableContainer");
      if (!universeData.length) {
        container.innerHTML = `
          <div style="padding:10px;color:var(--text-muted);">
            No data loaded. Upload a Stock Universe CSV.
          </div>
        `;
        return;
      }

      sortTable(universeData, universeSort);

      const h = (label, key) => {
        const arrow = universeSort.key===key
          ? (universeSort.direction==="asc" ? "▲" : "▼")
          : "";
        return `<th data-key="${key}">
          ${label}<span class="sort-indicator">${arrow}</span>
        </th>`;
      };

      container.innerHTML = `
        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                ${h("Rank","rank")}
                ${h("Ticker","ticker")}
                ${h("Company","company")}
                ${h("Total","totalScore")}
                ${h("Quality","qualityScore")}
                ${h("Value","valueScore")}
                ${h("Growth","growthScore")}
                ${h("ROIC","roic")}
                ${h("FCF Yield","fcfYield")}
                ${h("P/E","pe")}
                ${h("Fwd P/E","forwardPe")}
                ${h("Price","currentPrice")}
                ${h("RV Price","relativeValuationPrice")}
                ${h("Prem/Disc %","premiumDiscountPct")}
              </tr>
            </thead>
            <tbody>
              ${universeData.map(r=>`
                <tr>
                  <td>${r.rank}</td>
                  <td>${r.ticker}</td>
                  <td>${r.company}</td>
                  <td>${r.totalScore}</td>
                  <td>${r.qualityScore}</td>
                  <td>${r.valueScore}</td>
                  <td>${r.growthScore}</td>
                  <td>${r.roic}</td>
                  <td>${r.fcfYield}</td>
                  <td>${r.pe}</td>
                  <td>${r.forwardPe}</td>
                  <td>${r.currentPrice}</td>
                  <td>${r.relativeValuationPrice}</td>
                  <td>${r.premiumDiscountPct}</td>
                </tr>
              `).join("")}
            </tbody>
          </table>
        </div>
      `;

      attachUniverseSortHandlers();
    }

    function attachUniverseSortHandlers() {
      const headers = document.querySelectorAll(
        "#universeTableContainer th[data-key]"
      );
      headers.forEach(th => {
        th.onclick = () => {
          const key = th.dataset.key;
          if (universeSort.key === key) {
            universeSort.direction =
              universeSort.direction==="asc" ? "desc" : "asc";
          } else {
            universeSort.key = key;
            universeSort.direction = "asc";
          }
          renderUniverseTable();
        };
      });
    }

    /*******************************************************
     * SETUP PORTFOLIO VIEW — Load & Display
     *******************************************************/
    async function setupPortfolioView() {
      const btn = document.getElementById("portfolioUploadBtn");
      btn.onclick = () => portfolioFileInput.click();

      try {
        portfolioData = await loadPortfolioFromFirestore();
      } catch(err) {
        showToast("Error loading portfolio.", false);
      }
      renderPortfolioTable();
    }

    /*******************************************************
     * SETUP STOCK UNIVERSE VIEW — Load & Display
     *******************************************************/
    async function setupUniverseView() {
      const btn = document.getElementById("universeUploadBtn");
      btn.onclick = () => universeFileInput.click();

      try {
        universeData = await loadUniverseFromFirestore();
      } catch(err) {
        showToast("Error loading universe.", false);
      }
      renderUniverseTable();
    }

    /*******************************************************
     * HANDLE PORTFOLIO CSV UPLOAD
     *******************************************************/
    portfolioFileInput.addEventListener("change", evt=>{
      const f = evt.target.files[0];
      if (!f) return;

      const reader = new FileReader();
      reader.onload = async e => {
        try {
          const parsed = parsePortfolioCSV(e.target.result);
          await replacePortfolioInFirestore(parsed);
          portfolioData = await loadPortfolioFromFirestore();
          renderPortfolioTable();
          showToast("Portfolio rankings uploaded.");
        } catch(err) {
          showToast(err.message, false);
        }
        portfolioFileInput.value = "";
      };
      reader.readAsText(f);
    });

    /*******************************************************
     * HANDLE STOCK UNIVERSE CSV UPLOAD
     *******************************************************/
    universeFileInput.addEventListener("change", evt=>{
      const f = evt.target.files[0];
      if (!f) return;

      const reader = new FileReader();
      reader.onload = async e => {
        try {
          const parsed = parseUniverseCSV(e.target.result);
          await replaceUniverseInFirestore(parsed);
          universeData = await loadUniverseFromFirestore();
          renderUniverseTable();
          showToast("Universe uploaded.");
        } catch(err) {
          showToast(err.message,false);
        }
        universeFileInput.value = "";
      };
      reader.readAsText(f);
    });
    /*******************************************************
     * REPORTS: FIRESTORE + STORAGE HELPERS
     *******************************************************/
    async function saveReportMetadata(ticker, report) {
      const refDoc = doc(db, "companies", ticker, "reports", report.id);
      await setDoc(refDoc, report, { merge: true });
    }

    async function loadReportsForCompany(ticker) {
      const colRef = collection(db, "companies", ticker, "reports");
      const snap = await getDocs(colRef);
      const out = [];
      snap.forEach(docSnap => out.push(docSnap.data()));
      return out;
    }

    /*******************************************************
     * REPORT PDF UPLOAD HANDLER
     *******************************************************/
    const reportFileInput = document.getElementById("reportFileInput");

    reportFileInput.addEventListener("change", async (e) => {
      const files = Array.from(e.target.files || []);
      if (!currentReportCompanyId || !files.length) return;

      const company = companies.find(c => c.id === currentReportCompanyId);
      if (!company) return;

      try {
        const tasks = files
          .filter(f => f.type === "application/pdf")
          .map(async (file) => {
            const now = Date.now();
            const reportId = `${now}-${file.name}`;
            const storageRef = ref(storage, `reports/${company.ticker}/${reportId}`);

            await uploadBytes(storageRef, file);
            const url = await getDownloadURL(storageRef);

            const report = {
              id: reportId,
              title: file.name.replace(/\.pdf$/i, ""),
              date: new Date().toISOString().slice(0, 10),
              type: "Uploaded PDF",
              author: "Taylor Hoffman Inc.",
              url,
              uploadedAt: now
            };

            await saveReportMetadata(company.ticker, report);
          });

        await Promise.all(tasks);

        showToast("Reports uploaded.");
        const freshReports = await loadReportsForCompany(company.ticker);
        renderCompanySnapshot({ ...company, reports: freshReports });
      } catch (err) {
        console.error(err);
        showToast("Failed to upload reports.", false);
      } finally {
        reportFileInput.value = "";
      }
    });

    /*******************************************************
     * COMPANY SNAPSHOT (ABOVE HOLDINGS)
     *******************************************************/
    async function renderCompanySnapshot(company) {
      currentReportCompanyId = company.id;

      // Hide placeholder text and show snapshot section
      placeholder.style.display = "none";
      snapshotSection.style.display = "block";

      // Ensure we have latest reports
      const reports = await loadReportsForCompany(company.ticker);
      const sortedReports = [...reports].sort(
        (a,b) => (b.uploadedAt || 0) - (a.uploadedAt || 0)
      );

      const reportsHtml = sortedReports.length
        ? sortedReports.map(r => `
            <div class="report-row" style="
              display:flex;justify-content:space-between;
              gap:12px;padding:10px;border-radius:12px;
              border:1px solid rgba(31,41,55,0.9);
              background:radial-gradient(circle at top left,#020617,#020617);
            ">
              <div class="report-main" style="min-width:0;">
                <div class="report-title" style="
                  font-size:0.88rem;
                  white-space:nowrap;
                  overflow:hidden;
                  text-overflow:ellipsis;">
                  ${r.title}
                </div>
                <div class="report-meta" style="
                  font-size:0.75rem;
                  color:var(--text-muted);
                  display:flex;
                  flex-wrap:wrap;
                  gap:8px;">
                  <span>${r.date}</span>
                  <span class="dot" style="
                    width:3px;height:3px;border-radius:999px;
                    background:#6b7280;align-self:center;"></span>
                  <span>${r.type}</span>
                  <span class="dot" style="
                    width:3px;height:3px;border-radius:999px;
                    background:#6b7280;align-self:center;"></span>
                  <span>${r.author}</span>
                </div>
              </div>
              <div class="report-actions" style="display:flex;gap:8px;flex-shrink:0;">
                <a class="btn btn-download" href="${r.url}" download>
                  Download
                </a>
                <a class="btn btn-secondary" href="${r.url}" target="_blank">
                  Open
                </a>
              </div>
            </div>
          `).join("")
        : `<div class="empty-state" style="color:var(--text-muted);font-size:0.84rem;">
             No reports uploaded yet.
           </div>`;

      snapshotSection.innerHTML = `
        <section class="snapshot-card">
          <header class="snapshot-header">
            <div>
              <h1 style="font-size:1.1rem;margin-bottom:4px;">${company.name}</h1>
              <div class="ticker-chip">${company.ticker}</div>
            </div>
            <div style="text-align:right;font-size:0.78rem;color:var(--text-muted);">
              <div style="
                display:inline-flex;align-items:center;gap:6px;
                padding:2px 8px;border-radius:999px;
                border:1px solid rgba(79,70,229,0.7);
                background:var(--accent-soft);
                color:#c7d2fe;
                margin-bottom:4px;">
                <span style="
                  width:6px;height:6px;border-radius:50%;
                  background:#22c55e;"></span>
                <span>${company.coverage || "Unspecified"}</span>
              </div>
              <div>${company.sector || "—"}</div>
            </div>
          </header>

          <section class="section" style="
            margin-top:8px;
            border-radius:var(--radius-md);
            border:1px solid rgba(31,41,55,0.9);
            padding:14px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
              <div>
                <div style="font-size:0.85rem;letter-spacing:0.14em;text-transform:uppercase;color:#9ca3af;">
                  Reports
                </div>
                <div style="font-size:0.8rem;color:#6b7280;">
                  Uploaded research PDFs
                </div>
              </div>
              <button id="uploadReportBtn" class="btn btn-secondary">
                Upload PDF
              </button>
            </div>
            <div class="reports-list" style="display:flex;flex-direction:column;gap:8px;">
              ${reportsHtml}
            </div>
          </section>
        </section>
      `;

      const uploadReportBtn = document.getElementById("uploadReportBtn");
      uploadReportBtn.onclick = () => {
        reportFileInput.value = "";
        reportFileInput.click();
      };
    }

    /*******************************************************
     * SEARCH: AUTOCOMPLETE + SELECTION
     *******************************************************/
    searchInput.addEventListener("input", () => {
      const q = searchInput.value.trim().toLowerCase();
      if (!q) {
        resultsDropdown.classList.remove("visible");
        resultsDropdown.innerHTML = "";
        return;
      }

      const matches = companies.filter(c =>
        (c.name || "").toLowerCase().includes(q) ||
        (c.ticker || "").toLowerCase().includes(q)
      );

      if (!matches.length) {
        resultsDropdown.innerHTML = `
          <div style="padding:10px 14px;color:var(--text-muted);font-size:0.84rem;">
            No results.
          </div>
        `;
      } else {
        resultsDropdown.innerHTML = matches.map(c => `
          <div class="result-item" data-id="${c.id}">
            <div>
              <div style="font-size:0.88rem;">${c.name}</div>
              <div style="font-size:0.76rem;color:var(--text-muted);">
                ${c.sector || "—"}
              </div>
            </div>
            <div style="
              border-radius:999px;
              border:1px solid rgba(148,163,184,0.5);
              padding:3px 8px;
              font-size:0.75rem;">
              ${c.ticker}
            </div>
          </div>
        `).join("");
      }

      resultsDropdown.classList.add("visible");
    });

    resultsDropdown.addEventListener("click",(e)=>{
      const item = e.target.closest(".result-item");
      if (!item) return;

      const id = item.dataset.id;
      const c = companies.find(x => x.id === id);
      if (!c) return;

      showMenu(); // ensures we're in the hub view with holdings visible
      searchInput.value = `${c.name} (${c.ticker})`;
      resultsDropdown.classList.remove("visible");
      resultsDropdown.innerHTML = "";
      renderCompanySnapshot(c);
    });

    document.addEventListener("click",(e)=>{
      if (!resultsDropdown.contains(e.target) &&
          !searchInput.contains(e.target)) {
        resultsDropdown.classList.remove("visible");
      }
    });
    /*******************************************************
     * INITIAL LOAD
     *******************************************************/
    (async function init() {
      try {
        companies = await loadCompaniesFromFirestore();
      } catch (err) {
        console.error("Error loading companies:", err);
        showToast("Failed to load companies from cloud.", false);
      } finally {
        renderHoldingsGrid();
      }
    })();

    </script>
  </div> <!-- end .page -->
</body>
</html>
