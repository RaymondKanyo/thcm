<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Taylor Hoffman Research Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #050816;
      --bg-elevated: #0b1020;
      --accent: #4f46e5;
      --accent-soft: rgba(79, 70, 229, 0.12);
      --accent-border: rgba(129, 140, 248, 0.6);
      --text-main: #f9fafb;
      --text-muted: #9ca3af;
      --border-subtle: rgba(148, 163, 184, 0.25);
      --danger: #ef4444;
      --radius-lg: 16px;
      --radius-md: 10px;
      --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.9);
      --shadow-subtle: 0 10px 30px rgba(15, 23, 42, 0.6);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #111827 0, #020617 40%, #020617 100%);
      color: var(--text-main);
      min-height: 100vh;
    }

    .page {
      max-width: 1100px;
      margin: 0 auto;
      padding: 24px 16px 48px;
    }

    .header {
      position: sticky;
      top: 0;
      z-index: 50;
      padding-bottom: 16px;
      margin-bottom: 24px;
      backdrop-filter: blur(20px);
      background: linear-gradient(
        to bottom,
        rgba(2, 6, 23, 0.95),
        rgba(2, 6, 23, 0.88),
        transparent
      );
    }

    .brand-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 14px;
      gap: 12px;
    }

    .brand-left {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .brand-title {
      font-size: 1.3rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #e5e7eb;
    }

    .brand-subtitle {
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    .back-btn {
      display: none;
      border-radius: 999px;
      padding: 7px 12px;
      font-size: 0.78rem;
      border: 1px solid rgba(148, 163, 184, 0.5);
      background: rgba(15, 23, 42, 0.9);
      color: #e5e7eb;
      cursor: pointer;
      gap: 6px;
      align-items: center;
    }

    .back-btn::before {
      content: "←";
      font-size: 0.85rem;
    }

    .search-upload-row {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .search-container {
      position: relative;
      flex: 1;
      min-width: 260px;
    }

    .search-box {
      display: flex;
      align-items: center;
      gap: 8px;
      background: radial-gradient(circle at top left, #111827, #020617);
      border-radius: 999px;
      padding: 10px 14px;
      border: 1px solid var(--border-subtle);
      box-shadow: var(--shadow-subtle);
    }

    .search-box:focus-within {
      border-color: var(--accent-border);
      box-shadow: 0 0 0 1px rgba(129, 140, 248, 0.8), var(--shadow-soft);
      background: radial-gradient(circle at top left, #020617, #020617);
    }

    .search-input {
      border: none;
      outline: none;
      background: transparent;
      color: var(--text-main);
      width: 100%;
      font-size: 0.95rem;
    }

    .search-input::placeholder {
      color: #6b7280;
    }

    .results-dropdown {
      position: absolute;
      top: 44px;
      left: 0;
      right: 0;
      background: #020617;
      border-radius: 18px;
      border: 1px solid var(--border-subtle);
      box-shadow: var(--shadow-soft);
      max-height: 260px;
      overflow-y: auto;
      padding: 6px 0;
      display: none;
      z-index: 40;
    }

    .results-dropdown.visible {
      display: block;
    }

    .result-item {
      padding: 10px 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      transition: background 0.12s ease;
    }

    .result-item:hover {
      background-image: linear-gradient(
        to right,
        rgba(79, 70, 229, 0.16),
        transparent
      );
    }

    .result-main {
      display: flex;
      flex-direction: column;
      gap: 1px;
    }

    .result-name {
      font-size: 0.88rem;
    }

    .result-sector {
      font-size: 0.76rem;
      color: var(--text-muted);
    }

    .result-ticker-pill {
      border-radius: 999px;
      padding: 3px 8px;
      font-size: 0.75rem;
      border: 1px solid rgba(148, 163, 184, 0.5);
      color: #e5e7eb;
    }

    .btn-upload {
      border-radius: 999px;
      padding: 8px 14px;
      font-size: 0.8rem;
      border: none;
      cursor: pointer;
      background: var(--accent);
      color: #e5e7eb;
      box-shadow: 0 10px 30px rgba(79, 70, 229, 0.7);
      white-space: nowrap;
    }

    .btn-upload:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 40px rgba(79, 70, 229, 0.9);
    }

    /* MENU HUB */

    .menu-hub {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 14px;
      margin-bottom: 20px;
    }

    .menu-card {
      border-radius: var(--radius-lg);
      padding: 18px 16px;
      background: radial-gradient(circle at top left, #0b1020, #020617);
      border: 1px solid rgba(148, 163, 184, 0.35);
      box-shadow: var(--shadow-subtle);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 90px;
      text-align: center;
      transition: transform 0.12s ease, box-shadow 0.12s ease, border-color 0.12s ease;
    }

    .menu-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 16px 40px rgba(15, 23, 42, 0.9);
      border-color: var(--accent-border);
    }

    .menu-card-label {
      font-size: 0.9rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .menu-card-label-muted {
      color: var(--text-muted);
    }

    /* HOLDINGS SECTION */

    .holdings-section {
      margin-bottom: 20px;
    }

    .holdings-header {
      margin-bottom: 10px;
    }

    .holdings-title {
      font-size: 0.9rem;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: #9ca3af;
      margin-bottom: 4px;
    }

    .holdings-subtitle {
      font-size: 0.83rem;
      color: #6b7280;
    }

    .holdings-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }

    .holding-card {
      border-radius: 14px;
      padding: 10px 10px 9px;
      background: radial-gradient(circle at top left, #020617, #020617);
      border: 1px solid rgba(30, 64, 175, 0.7);
      cursor: pointer;
      transition: transform 0.12s ease, box-shadow 0.12s ease, border-color 0.12s ease;
    }

    .holding-card:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.9);
      border-color: rgba(129, 140, 248, 0.9);
    }

    .holding-name {
      font-size: 0.86rem;
      margin-bottom: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .holding-ticker {
      font-size: 0.78rem;
      color: #9ca3af;
      margin-bottom: 6px;
    }

    .holding-coverage {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.75rem;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.5);
    }

    .coverage-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
    }

    .coverage-active .coverage-dot {
      background: #22c55e;
    }
    .coverage-inactive .coverage-dot {
      background: #f97316;
    }
    .coverage-unknown .coverage-dot {
      background: #6b7280;
    }

    .holdings-empty {
      font-size: 0.82rem;
      color: var(--text-muted);
      padding: 10px 4px 2px;
    }

    /* MENU VIEW (Portfolio page, etc.) */

    .menu-view {
      display: none;
      margin-bottom: 20px;
    }

    .menu-view-inner {
      margin-top: 4px;
      padding: 16px 14px 14px;
      border-radius: var(--radius-lg);
      background: radial-gradient(circle at top left, #020617, #020617);
      border: 1px solid rgba(148, 163, 184, 0.35);
      box-shadow: var(--shadow-soft);
    }

    .menu-view-title {
      font-size: 1rem;
      margin-bottom: 3px;
    }

    .menu-view-subtitle {
      font-size: 0.84rem;
      color: var(--text-muted);
    }

    .portfolio-controls {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    .portfolio-upload-btn {
      border-radius: 999px;
      padding: 8px 14px;
      font-size: 0.8rem;
      border: none;
      cursor: pointer;
      background: var(--accent);
      color: #e5e7eb;
      box-shadow: 0 10px 30px rgba(79, 70, 229, 0.7);
      white-space: nowrap;
    }

    .portfolio-upload-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 40px rgba(79, 70, 229, 0.9);
    }

    .table-container {
      width: 100%;
      overflow-x: auto;
      border-radius: 14px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: radial-gradient(circle at top left, #020617, #020617);
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
    }

    .data-table th,
    .data-table td {
      padding: 6px 6px;
      text-align: center;
      border-bottom: 1px solid rgba(31, 41, 55, 0.9);
      white-space: nowrap;
    }

    .data-table thead {
      background: rgba(15, 23, 42, 0.95);
      position: sticky;
      top: 0;
      z-index: 1;
    }

    .data-table tbody tr:nth-child(even) {
      background: rgba(15, 23, 42, 0.6);
    }

    .data-table tbody tr:hover {
      background: rgba(30, 64, 175, 0.35);
    }

    th.sortable {
      cursor: pointer;
    }

    .sort-indicator {
      font-size: 0.7rem;
      opacity: 0.7;
      margin-left: 4px;
    }

    /* MAIN + SNAPSHOT */

    main {
      margin-top: 6px;
    }

    .placeholder {
      margin-top: 10px;
      padding: 16px 14px;
      border-radius: var(--radius-lg);
      border: 1px dashed rgba(148, 163, 184, 0.7);
      color: var(--text-muted);
      font-size: 0.86rem;
      background: radial-gradient(circle at top left, #020617, #020617);
    }

    .snapshot-card {
      margin-top: 16px;
      padding: 20px 18px;
      border-radius: var(--radius-lg);
      background: radial-gradient(circle at top left, #020617, #020617);
      border: 1px solid rgba(148, 163, 184, 0.7);
      box-shadow: var(--shadow-soft);
    }

    .snapshot-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 12px;
      margin-bottom: 16px;
    }

    .snapshot-title-group h1 {
      font-size: 1.1rem;
      margin-bottom: 4px;
    }

    .ticker-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 2px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      font-size: 0.75rem;
      color: #e5e7eb;
      background: rgba(15, 23, 42, 0.8);
    }

    .snapshot-meta {
      text-align: right;
      font-size: 0.78rem;
      color: var(--text-muted);
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(79, 70, 229, 0.7);
      background: var(--accent-soft);
      color: #c7d2fe;
      margin-bottom: 4px;
      font-size: 0.72rem;
    }

    .section {
      margin-top: 10px;
      border-radius: var(--radius-md);
      border: 1px solid rgba(31, 41, 55, 0.9);
      background: radial-gradient(circle at top left, #020617, #020617);
      padding: 14px 14px 10px;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      gap: 8px;
    }

    .section-title {
      font-size: 0.85rem;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: #9ca3af;
    }

    .section-subtitle {
      font-size: 0.8rem;
      color: #6b7280;
    }

    .reports-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .report-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 10px 10px;
      border-radius: 12px;
      border: 1px solid rgba(31, 41, 55, 0.9);
      background: radial-gradient(circle at top left, #020617, #020617);
    }

    .report-main {
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-width: 0;
    }

    .report-title {
      font-size: 0.88rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .report-meta {
      font-size: 0.75rem;
      color: var(--text-muted);
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .dot {
      width: 3px;
      height: 3px;
      border-radius: 999px;
      background: #6b7280;
      align-self: center;
    }

    .report-actions {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-shrink: 0;
    }

    .btn {
      border-radius: 999px;
      padding: 7px 12px;
      font-size: 0.8rem;
      border: none;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
      transition: background 0.12s ease, transform 0.08s ease, box-shadow 0.12s ease;
      text-decoration: none;
    }

    .btn-download {
      background: var(--accent);
      color: #e5e7eb;
      box-shadow: 0 10px 30px rgba(79, 70, 229, 0.7);
    }

    .btn-download:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 40px rgba(79, 70, 229, 0.9);
    }

    .btn-secondary {
      background: rgba(15, 23, 42, 1);
      color: #e5e7eb;
      border: 1px solid rgba(55, 65, 81, 0.9);
    }

    .btn-secondary:hover {
      background: rgba(15, 23, 42, 0.9);
    }

    .btn-icon {
      width: 14px;
      height: 14px;
      flex-shrink: 0;
    }

    .empty-state {
      font-size: 0.82rem;
      color: var(--text-muted);
      padding: 8px 2px;
    }

    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 12px 18px;
      border-radius: 12px;
      font-size: 0.85rem;
      background: var(--bg-elevated);
      border: 1px solid var(--accent-border);
      box-shadow: var(--shadow-soft);
      opacity: 0;
      transition: opacity .3s ease;
      z-index: 200;
    }
    .toast.show { opacity: 1; }

    @media (max-width: 640px) {
      .brand-row {
        flex-direction: column;
        align-items: flex-start;
      }
      .snapshot-header {
        flex-direction: column;
        align-items: flex-start;
      }
      .snapshot-meta {
        text-align: left;
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <!-- HEADER -->
    <header class="header">
      <div class="brand-row">
        <div class="brand-left">
          <div class="brand-title">Taylor Hoffman Inc.</div>
          <div class="brand-subtitle">Internal Equity Research Portal</div>
        </div>
        <button id="backBtn" class="back-btn" type="button">Back to Menu</button>
      </div>

      <div class="search-upload-row">
        <div class="search-container">
          <div class="search-box">
            <input
              id="companySearch"
              class="search-input"
              type="text"
              placeholder="Search by company or ticker…"
              autocomplete="off"
            />
          </div>
          <div id="resultsDropdown" class="results-dropdown"></div>
        </div>

        <button class="btn-upload" id="uploadBtn">Upload Companies CSV</button>
        <input type="file" id="fileInput" accept=".csv" style="display:none;" />
      </div>
    </header>
    <!-- MENU HUB -->
    <section id="menuHub" class="menu-hub">
      <div class="menu-card" data-view="portfolio">
        <span class="menu-card-label">Portfolio Rankings</span>
      </div>
      <div class="menu-card" data-view="placeholder-1">
        <span class="menu-card-label menu-card-label-muted">Placeholder One</span>
      </div>
      <div class="menu-card" data-view="placeholder-2">
        <span class="menu-card-label menu-card-label-muted">Placeholder Two</span>
      </div>
      <div class="menu-card" data-view="placeholder-3">
        <span class="menu-card-label menu-card-label-muted">Placeholder Three</span>
      </div>
    </section>

    <!-- PORTFOLIO HOLDINGS -->
    <section id="holdingsSection" class="holdings-section">
      <div class="holdings-header">
        <div class="holdings-title">Portfolio Holdings</div>
        <div class="holdings-subtitle">
          Coverage universe tiles – click any company to open its snapshot.
        </div>
      </div>
      <div id="holdingsGrid" class="holdings-grid">
        <!-- Filled by JS -->
      </div>
    </section>

    <!-- MENU VIEW (for Portfolio Rankings, etc.) -->
    <section id="menuView" class="menu-view"></section>

    <!-- MAIN RESEARCH VIEW -->
    <main>
      <div id="placeholder" class="placeholder">
        Upload a company list CSV or select a company to view its snapshot and reports.
      </div>
      <div id="snapshotContainer"></div>
    </main>
  </div>

  <!-- Hidden inputs for uploads -->
  <input type="file" id="reportFileInput" accept="application/pdf" multiple style="display:none;" />
  <input type="file" id="portfolioFileInput" accept=".csv" style="display:none;" />

  <!-- Toast -->
  <div id="toast" class="toast"></div>

  <!-- APP SCRIPT WITH FIREBASE + LOGIC -->
  <script type="module">
    /********************************************************
     *  FIREBASE SETUP
     ********************************************************/
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-analytics.js";
    import {
      getFirestore,
      collection,
      getDocs,
      setDoc,
      doc,
      deleteDoc
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
    import {
      getStorage,
      ref,
      uploadBytes,
      getDownloadURL
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCvkNdmrZ9Nt8osFM7TtCwe7Sw7xGPLp3Q",
      authDomain: "thcm-f24f1.firebaseapp.com",
      projectId: "thcm-f24f1",
      storageBucket: "thcm-f24f1.firebasestorage.app",
      messagingSenderId: "192941719200",
      appId: "1:192941719200:web:5ea861d487b635214093c5",
      measurementId: "G-15Q7VPVKPF"
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    /********************************************************
     *  STATE
     ********************************************************/
    let companies = [];  // from Firestore
    let currentReportCompanyId = null;
    let activeView = "menu";

    let portfolioData = [];
    let portfolioSort = { key: "totalScore", direction: "desc" };

    /********************************************************
     *  ELEMENTS
     ********************************************************/
    const searchInput = document.getElementById("companySearch");
    const resultsDropdown = document.getElementById("resultsDropdown");
    const snapshotContainer = document.getElementById("snapshotContainer");
    const placeholder = document.getElementById("placeholder");
    const toast = document.getElementById("toast");

    const fileInput = document.getElementById("fileInput");
    const uploadBtn = document.getElementById("uploadBtn");

    const reportFileInput = document.getElementById("reportFileInput");
    const portfolioFileInput = document.getElementById("portfolioFileInput");

    const menuHub = document.getElementById("menuHub");
    const menuView = document.getElementById("menuView");
    const backBtn = document.getElementById("backBtn");
    const mainSection = document.querySelector("main");
    const holdingsSection = document.getElementById("holdingsSection");
    const holdingsGrid = document.getElementById("holdingsGrid");

    /********************************************************
     *  FIRESTORE HELPERS (COMPANIES + REPORTS + PORTFOLIO)
     ********************************************************/
    async function loadCompaniesFromFirestore() {
      const snap = await getDocs(collection(db, "companies"));
      const result = [];
      snap.forEach((docSnap) => {
        const data = docSnap.data();
        result.push({
          id: docSnap.id,
          ticker: data.ticker,
          name: data.name,
          sector: data.sector,
          coverage: data.coverage,
          reports: []
        });
      });
      return result;
    }

    async function saveCompaniesToFirestore(companiesArray) {
      const promises = companiesArray.map((c) => {
        const refDoc = doc(db, "companies", c.ticker);
        return setDoc(refDoc, {
          ticker: c.ticker,
          name: c.name,
          sector: c.sector,
          coverage: c.coverage
        }, { merge: true });
      });
      await Promise.all(promises);
    }

    async function saveReportMetadata(ticker, report) {
      const refDoc = doc(db, "companies", ticker, "reports", report.id);
      await setDoc(refDoc, report, { merge: true });
    }

    async function loadReportsForCompany(ticker) {
      const colRef = collection(db, "companies", ticker, "reports");
      const snap = await getDocs(colRef);
      const result = [];
      snap.forEach((docSnap) => {
        result.push(docSnap.data());
      });
      return result;
    }

    // --- Portfolio Rankings helpers (new, cloud-backed) ---
    async function loadPortfolioFromFirestore() {
      const colRef = collection(db, "portfolioRankings");
      const snap = await getDocs(colRef);
      const result = [];
      snap.forEach((docSnap) => {
        result.push(docSnap.data());
      });
      return result;
    }

    async function replacePortfolioInFirestore(rows) {
      const colRef = collection(db, "portfolioRankings");

      // delete all existing docs
      const existingSnap = await getDocs(colRef);
      const deletions = existingSnap.docs.map(d => deleteDoc(d.ref));
      await Promise.all(deletions);

      // write new rows
      const writes = rows.map(row => {
        const id = row.ticker || Math.random().toString(36).slice(2);
        return setDoc(doc(db, "portfolioRankings", id), row);
      });
      await Promise.all(writes);
    }

    /********************************************************
     *  TOAST
     ********************************************************/
    function showToast(msg, ok = true) {
      toast.textContent = msg;
      toast.style.borderColor = ok ? "var(--accent-border)" : "var(--danger)";
      toast.classList.add("show");
      setTimeout(() => toast.classList.remove("show"), 2500);
    }

    /********************************************************
     *  COVERAGE CLASS
     ********************************************************/
    function getCoverageClass(coverageRaw) {
      const cov = (coverageRaw || "").toLowerCase();

      if (cov.includes("inactive") || cov.includes("watchlist")) {
        return "coverage-inactive";
      }
      if (cov.includes("active")) {
        return "coverage-active";
      }
      return "coverage-unknown";
    }

    /********************************************************
     *  HOLDINGS GRID
     ********************************************************/
    function renderHoldingsGrid() {
      if (!companies.length) {
        holdingsGrid.innerHTML = `
          <div class="holdings-empty">
            No companies loaded yet. Upload a coverage CSV to see holdings tiles here.
          </div>
        `;
        return;
      }

      const sorted = [...companies].sort((a, b) =>
        (a.name || "").localeCompare(b.name || "")
      );

      holdingsGrid.innerHTML = sorted.map(c => {
        const covClass = getCoverageClass(c.coverage);
        return `
          <div class="holding-card" data-id="${c.id}">
            <div class="holding-name" title="${c.name}">${c.name}</div>
            <div class="holding-ticker">${c.ticker}</div>
            <div class="holding-coverage ${covClass}">
              <span class="coverage-dot"></span>
              <span>${c.coverage || "Unspecified"}</span>
            </div>
          </div>
        `;
      }).join("");
    }

    holdingsGrid.addEventListener("click", (e) => {
      const card = e.target.closest(".holding-card");
      if (!card) return;

      const id = card.dataset.id;
      const company = companies.find(c => c.id === id);
      if (!company) return;

      showMenu();
      searchInput.value = `${company.name} (${company.ticker})`;
      renderCompanySnapshot(company);
    });
    /********************************************************
     *  COMPANY CSV UPLOAD → FIRESTORE
     ********************************************************/
    uploadBtn.addEventListener("click", () => fileInput.click());
    fileInput.addEventListener("change", handleCompanyUpload);

    function parseCompanyCSV(text) {
      const lines = text.trim().split(/\r?\n/);
      if (lines.length < 2) throw new Error("CSV must contain header row.");

      const headers = lines[0].split(",").map(x => x.trim().toLowerCase());
      const idxTicker = headers.indexOf("ticker");
      const idxName = headers.indexOf("name");
      const idxSector = headers.indexOf("sector");
      const idxCoverage = headers.indexOf("coverage");

      if (idxTicker === -1 || idxName === -1) {
        throw new Error("CSV must include 'Ticker' and 'Name' columns.");
      }

      const out = [];
      for (let i = 1; i < lines.length; i++) {
        const row = lines[i].trim();
        if (!row) continue;

        const cols = row.split(",");
        const ticker = (cols[idxTicker] || "").trim();
        const name = (cols[idxName] || "").trim();
        if (!ticker || !name) continue;

        const sector = idxSector !== -1 ? (cols[idxSector] || "").trim() : "";
        const coverage = idxCoverage !== -1 ? (cols[idxCoverage] || "").trim() : "";

        out.push({
          id: ticker,
          ticker,
          name,
          sector: sector || "—",
          coverage: coverage || "Unspecified",
          reports: []
        });
      }
      return out;
    }

    async function handleCompanyUpload(e) {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = async (evt) => {
        try {
          const parsed = parseCompanyCSV(evt.target.result);

          await saveCompaniesToFirestore(parsed);
          showToast("Companies uploaded to cloud.");

          companies = await loadCompaniesFromFirestore();
          renderHoldingsGrid();
        } catch (err) {
          console.error(err);
          showToast(err.message || "Failed to upload companies.", false);
        } finally {
          fileInput.value = "";
        }
      };
      reader.readAsText(file);
    }

    /********************************************************
     *  MENU NAVIGATION
     ********************************************************/
    menuHub.addEventListener("click", (e) => {
      const card = e.target.closest(".menu-card");
      if (!card) return;
      const view = card.dataset.view;
      openMenuView(view);
    });

    backBtn.addEventListener("click", showMenu);

    function buildViewContent(view) {
      if (view === "portfolio") {
        return `
          <div class="menu-view-inner">
            <div class="portfolio-controls">
              <div class="portfolio-controls-left">
                <h2 class="menu-view-title">Portfolio Rankings</h2>
                <p class="menu-view-subtitle">Upload rankings CSV to populate the sortable table. Data is stored in the cloud and reloads on visit.</p>
              </div>
              <button id="portfolioUploadBtn" class="portfolio-upload-btn">Upload Rankings CSV</button>
            </div>
            <div id="portfolioTableContainer"></div>
          </div>
        `;
      }

      return `
        <div class="menu-view-inner">
          <h2 class="menu-view-title">Placeholder</h2>
          <p class="menu-view-subtitle">Reserved for future internal tools.</p>
        </div>
      `;
    }

    function openMenuView(view) {
      activeView = view;
      menuHub.style.display = "none";
      holdingsSection.style.display = "none";
      mainSection.style.display = "none";
      backBtn.style.display = "inline-flex";

      menuView.style.display = "block";
      menuView.innerHTML = buildViewContent(view);

      if (view === "portfolio") {
        setupPortfolioView();
      }
    }

    function showMenu() {
      activeView = "menu";
      menuHub.style.display = "grid";
      holdingsSection.style.display = "block";
      mainSection.style.display = "block";
      backBtn.style.display = "none";
      menuView.style.display = "none";
    }

    /********************************************************
     *  PORTFOLIO RANKINGS (NOW CLOUD-BACKED)
     ********************************************************/
    portfolioFileInput.addEventListener("change", handlePortfolioUpload);

    async function setupPortfolioView() {
      const btn = document.getElementById("portfolioUploadBtn");
      if (btn) btn.addEventListener("click", () => portfolioFileInput.click());

      try {
        portfolioData = await loadPortfolioFromFirestore();
      } catch (err) {
        console.error("Error loading portfolio from Firestore", err);
        showToast("Could not load portfolio rankings.", false);
      }
      renderPortfolioTable();
    }

    function parsePortfolioCSV(text) {
      const lines = text.trim().split(/\r?\n/);
      if (lines.length < 2) throw new Error("Invalid CSV");

      const headers = lines[0].split(",").map(x => x.trim().toLowerCase());
      const req = [
        "ticker","company","total score","quality score","value score","growth score",
        "roic","fcf yield","p/e","forward p/e","current price",
        "relative valuation price","premium/discount %"
      ];

      const idx = {};
      for (const h of req) {
        const i = headers.indexOf(h);
        if (i === -1) throw new Error(`Missing column: ${h}`);
        idx[h] = i;
      }

      const out = [];
      for (let i = 1; i < lines.length; i++) {
        const row = lines[i].trim();
        if (!row) continue;

        const c = row.split(",");
        const get = h => (c[idx[h]] || "").trim();

        out.push({
          ticker: get("ticker"),
          company: get("company"),
          totalScore: get("total score"),
          qualityScore: get("quality score"),
          valueScore: get("value score"),
          growthScore: get("growth score"),
          roic: get("roic"),
          fcfYield: get("fcf yield"),
          pe: get("p/e"),
          forwardPe: get("forward p/e"),
          currentPrice: get("current price"),
          relativeValuationPrice: get("relative valuation price"),
          premiumDiscountPct: get("premium/discount %")
        });
      }
      return out;
    }

    async function handlePortfolioUpload(e) {
      const f = e.target.files[0];
      if (!f) return;

      const reader = new FileReader();
      reader.onload = async (evt) => {
        try {
          const parsed = parsePortfolioCSV(evt.target.result);

          // Save to Firestore (replace existing portfolio)
          await replacePortfolioInFirestore(parsed);
          showToast("Portfolio rankings uploaded to cloud.");

          // Reload from Firestore for a clean copy
          portfolioData = await loadPortfolioFromFirestore();
          portfolioSort = { key: "totalScore", direction: "desc" };
          renderPortfolioTable();
        } catch (err) {
          console.error(err);
          showToast(err.message || "Failed to upload portfolio.", false);
        } finally {
          portfolioFileInput.value = "";
        }
      };
      reader.readAsText(f);
    }

    function applyPortfolioSort() {
      const key = portfolioSort.key;
      const dir = portfolioSort.direction === "asc" ? 1 : -1;

      portfolioData.sort((a, b) => {
        const va = a[key];
        const vb = b[key];

        if (key === "ticker" || key === "company") {
          return va.localeCompare(vb) * dir;
        }

        const na = parseFloat(va);
        const nb = parseFloat(vb);
        if (isNaN(na)) return 1;
        if (isNaN(nb)) return -1;
        return (na - nb) * dir;
      });
    }

    function renderPortfolioTable() {
      const container = document.getElementById("portfolioTableContainer");
      if (!container) return;

      if (!portfolioData.length) {
        container.innerHTML = `
          <div class="empty-state">
            No data loaded. Upload a Rankings CSV.
          </div>
        `;
        return;
      }

      applyPortfolioSort();

      const h = (label, key) => {
        const arrow = portfolioSort.key === key
          ? (portfolioSort.direction === "asc" ? "▲" : "▼")
          : "";
        return `
          <th class="sortable" data-key="${key}">
            ${label} <span class="sort-indicator">${arrow}</span>
          </th>
        `;
      };

      container.innerHTML = `
        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                ${h("Ticker","ticker")}
                ${h("Company","company")}
                ${h("Total Score","totalScore")}
                ${h("Quality","qualityScore")}
                ${h("Value","valueScore")}
                ${h("Growth","growthScore")}
                ${h("ROIC","roic")}
                ${h("FCF Yield","fcfYield")}
                ${h("P/E","pe")}
                ${h("Fwd P/E","forwardPe")}
                ${h("Price","currentPrice")}
                ${h("RV Price","relativeValuationPrice")}
                ${h("Prem/Disc %","premiumDiscountPct")}
              </tr>
            </thead>
            <tbody>
              ${portfolioData.map(r => `
                <tr>
                  <td>${r.ticker}</td>
                  <td>${r.company}</td>
                  <td>${r.totalScore}</td>
                  <td>${r.qualityScore}</td>
                  <td>${r.valueScore}</td>
                  <td>${r.growthScore}</td>
                  <td>${r.roic}</td>
                  <td>${r.fcfYield}</td>
                  <td>${r.pe}</td>
                  <td>${r.forwardPe}</td>
                  <td>${r.currentPrice}</td>
                  <td>${r.relativeValuationPrice}</td>
                  <td>${r.premiumDiscountPct}</td>
                </tr>
              `).join("")}
            </tbody>
          </table>
        </div>
      `;

      attachSortHandlers();
    }

    function attachSortHandlers() {
      const headers = document.querySelectorAll("th.sortable");
      headers.forEach(th => {
        th.onclick = () => {
          const key = th.dataset.key;
          if (!key) return;

          if (portfolioSort.key === key) {
            portfolioSort.direction = portfolioSort.direction === "asc" ? "desc" : "asc";
          } else {
            portfolioSort.key = key;
            portfolioSort.direction = "desc";
          }
          renderPortfolioTable();
        };
      });
    }

    /********************************************************
     *  SEARCH
     ********************************************************/
    searchInput.addEventListener("input", () => {
      const q = searchInput.value.trim().toLowerCase();
      if (!q) return clearDropdown();

      const matches = companies.filter(c =>
        c.name.toLowerCase().includes(q) ||
        c.ticker.toLowerCase().includes(q)
      );
      renderDropdown(matches);
    });

    document.addEventListener("click", (e) => {
      if (!searchInput.contains(e.target) && !resultsDropdown.contains(e.target)) {
        clearDropdown();
      }
    });

    function renderDropdown(list) {
      if (!list.length) {
        resultsDropdown.innerHTML = `
          <div class="empty-state" style="padding:10px 14px;">
            No results.
          </div>`;
      } else {
        resultsDropdown.innerHTML = list.map(c => `
          <div class="result-item" data-id="${c.id}">
            <div class="result-main">
              <div class="result-name">${c.name}</div>
              <div class="result-sector">${c.sector}</div>
            </div>
            <div class="result-ticker-pill">${c.ticker}</div>
          </div>
        `).join("");
      }
      resultsDropdown.classList.add("visible");
    }

    resultsDropdown.addEventListener("click", (e) => {
      const item = e.target.closest(".result-item");
      if (!item) return;

      const id = item.dataset.id;
      const c = companies.find(x => x.id === id);
      if (!c) return;

      showMenu();
      searchInput.value = `${c.name} (${c.ticker})`;
      renderCompanySnapshot(c);
      clearDropdown();
    });

    function clearDropdown() {
      resultsDropdown.innerHTML = "";
      resultsDropdown.classList.remove("visible");
    }

    /********************************************************
     *  REPORT UPLOAD → STORAGE + FIRESTORE
     ********************************************************/
    reportFileInput.addEventListener("change", handleReportUpload);

    async function handleReportUpload(e) {
      const files = Array.from(e.target.files || []);
      if (!currentReportCompanyId || !files.length) return;

      const company = companies.find(c => c.id === currentReportCompanyId);
      if (!company) return;

      try {
        const tasks = files
          .filter(file => file.type === "application/pdf")
          .map(async (file) => {
            const now = Date.now();
            const reportId = `${now}-${file.name}`;
            const storageRef = ref(storage, `reports/${company.ticker}/${reportId}`);

            await uploadBytes(storageRef, file);
            const downloadURL = await getDownloadURL(storageRef);

            const report = {
              id: reportId,
              title: file.name.replace(/\.pdf$/i, ""),
              date: new Date().toISOString().slice(0, 10),
              type: "Uploaded PDF",
              author: "Taylor Hoffman Inc.",
              url: downloadURL,
              uploadedAt: now
            };

            await saveReportMetadata(company.ticker, report);
          });

        await Promise.all(tasks);

        showToast("Reports uploaded to cloud.");

        const freshReports = await loadReportsForCompany(company.ticker);
        company.reports = freshReports;
        renderCompanySnapshot(company);
      } catch (err) {
        console.error(err);
        showToast("Failed to upload reports.", false);
      } finally {
        reportFileInput.value = "";
      }
    }

    /********************************************************
     *  COMPANY SNAPSHOT (LOADS REPORTS FROM FIRESTORE)
     ********************************************************/
    async function renderCompanySnapshot(company) {
      currentReportCompanyId = company.id;
      placeholder.style.display = "none";

      const reports = await loadReportsForCompany(company.ticker);
      const sortedReports = [...reports].sort((a, b) =>
        (b.uploadedAt || 0) - (a.uploadedAt || 0)
      );

      const reportsHtml = sortedReports.length
        ? sortedReports.map(r => `
            <div class="report-row">
              <div class="report-main">
                <div class="report-title">${r.title}</div>
                <div class="report-meta">
                  <span>${r.date}</span>
                  <span class="dot"></span>
                  <span>${r.type}</span>
                  <span class="dot"></span>
                  <span>${r.author}</span>
                </div>
              </div>
              <div class="report-actions">
                <a class="btn btn-download" href="${r.url}" download>
                  <svg class="btn-icon" viewBox="0 0 24 24">
                    <path fill="currentColor" d="M5 20h14v-2H5v2zm7-18L5.33 9h3.92v4h5.5V9h3.92L12 2z"/>
                  </svg>
                  Download
                </a>
                <a class="btn btn-secondary" target="_blank" href="${r.url}">
                  <svg class="btn-icon" viewBox="0 0 24 24">
                    <path fill="currentColor" d="M14 3h7v7h-2V6.41l-9.29 9.3-1.42-1.42 9.3-9.29H14V3z"/>
                    <path fill="currentColor" d="M5 5h5V3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-5h-2v5H5V5z"/>
                  </svg>
                  Open
                </a>
              </div>
            </div>
          `).join("")
        : `<div class="empty-state">No reports uploaded yet.</div>`;

      snapshotContainer.innerHTML = `
        <section class="snapshot-card">
          <header class="snapshot-header">
            <div class="snapshot-title-group">
              <h1>${company.name}</h1>
              <div class="ticker-chip">${company.ticker}</div>
            </div>
            <div class="snapshot-meta">
              <div class="badge">
                <span style="width:6px;height:6px;border-radius:50%;background:#22c55e;"></span>
                <span>${company.coverage}</span>
              </div>
              <div>${company.sector}</div>
            </div>
          </header>
          <section class="section">
            <div class="section-header">
              <div class="section-header-text">
                <div class="section-title">Reports</div>
                <div class="section-subtitle">Uploaded research PDFs</div>
              </div>
              <button id="uploadReportBtn" class="btn btn-secondary">Upload PDF</button>
            </div>
            <div class="reports-list">
              ${reportsHtml}
            </div>
          </section>
        </section>
      `;

      document.getElementById("uploadReportBtn").onclick = () => {
        reportFileInput.value = "";
        reportFileInput.click();
      };
    }

    /********************************************************
     *  INITIAL LOAD
     ********************************************************/
    (async () => {
      try {
        companies = await loadCompaniesFromFirestore();
        renderHoldingsGrid();
      } catch (err) {
        console.error("Error loading companies from Firestore", err);
        renderHoldingsGrid();
      }
    })();
  </script>
</body>
</html>
